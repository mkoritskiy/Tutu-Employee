# OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Keycloak —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **Authorization Code Flow —Å PKCE** —á–µ—Ä–µ–∑
—Å–∏—Å—Ç–µ–º–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä. –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –Ω–∞—Ç–∏–≤–Ω—ã—Ö –∏ –¥–µ—Å–∫—Ç–æ–ø–Ω—ã—Ö
–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ OAuth —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä

### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **–ü–∞—Ä–æ–ª—å –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–º
  –±—Ä–∞—É–∑–µ—Ä–µ Keycloak
- **PKCE –∑–∞—â–∏—Ç–∞** - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ authorization code
- **State parameter** - –∑–∞—â–∏—Ç–∞ –æ—Ç CSRF –∞—Ç–∞–∫
- **–°–∏—Å—Ç–µ–º–∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –ø–∞—Ä–æ–ª–∏** - —Ä–∞–±–æ—Ç–∞ —Ç–æ–ª—å–∫–æ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏

### ‚úÖ –£–¥–æ–±—Å—Ç–≤–æ

- **Single Sign-On (SSO)** - –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –≤—Ö–æ–¥ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
  –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- **Unified experience** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–Ω–∞–∫–æ–º—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Keycloak
- **Multi-factor authentication** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ MFA, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ Keycloak

### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º

- **OAuth 2.0 / OpenID Connect** - –∏–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã
- **Best practices** - —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Ç IETF –∏ OAuth Security BCP

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              ‚îÇ  1. Auth ‚îÇ              ‚îÇ  Opens   ‚îÇ              ‚îÇ
‚îÇ     App      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí‚îÇ   Browser    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí‚îÇ   Keycloak   ‚îÇ
‚îÇ              ‚îÇ   URL    ‚îÇ              ‚îÇ          ‚îÇ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üë                                                     ‚îÇ
       ‚îÇ                                                     ‚îÇ
       ‚îÇ  3. Deep Link                           2. User    ‚îÇ
       ‚îÇ  (callback)                             Login      ‚îÇ
       ‚îÇ                                                     ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. BrowserHelper (expect/actual)

Platform-specific —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±—Ä–∞—É–∑–µ—Ä–æ–º:

```kotlin
// Common
expect fun openUrlInBrowser(url: String)
expect fun canHandleDeepLinks(): Boolean

@Composable
expect fun SetupOAuthCallbackHandler(onCallback: (String) -> Unit)
```

#### Android —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

```kotlin
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Chrome Custom Tabs –¥–ª—è –ª—É—á—à–µ–≥–æ UX
actual fun openUrlInBrowser(url: String) {
    val customTabsIntent = CustomTabsIntent.Builder()
        .setShowTitle(true)
        .build()
    customTabsIntent.launchUrl(context, Uri.parse(url))
}

// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç callback –≤ MainActivity –¥–ª—è Deep Links
@Composable
actual fun SetupOAuthCallbackHandler(onCallback: (String) -> Unit) {
    val activity = LocalContext.current as? MainActivity
    activity?.setOAuthCallback(onCallback)
}
```

#### iOS —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

```kotlin
// –û—Ç–∫—Ä—ã–≤–∞–µ—Ç Safari –∏–ª–∏ ASWebAuthenticationSession
actual fun openUrlInBrowser(url: String) {
    UIApplication.sharedApplication.openURL(NSURL.URLWithString(url))
}
```

### 2. KeycloakOAuthHandler

–£–ø—Ä–∞–≤–ª—è–µ—Ç OAuth flow:

```kotlin
class KeycloakOAuthHandler(
    private val config: KeycloakConfig,
    private val keycloakClient: KeycloakClient
) {
    // –°–æ–∑–¥–∞–Ω–∏–µ URL –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å PKCE
    suspend fun createAuthorizationUrl(
        scopes: List<String> = listOf("openid", "profile", "email"),
        usePKCE: Boolean = true
    ): String
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ callback URL —Å –∫–æ–¥–æ–º
    suspend fun handleAuthorizationCallback(
        callbackUrl: String
    ): Result<KeycloakTokens>
}
```

### 3. AuthViewModel

```kotlin
// –ò–Ω–∏—Ü–∏–∞—Ü–∏—è OAuth flow
fun startKeycloakOAuth() {
    viewModelScope.launch {
        getKeycloakAuthUrlUseCase()
            .onSuccess { url ->
                _uiState.value = _uiState.value.copy(keycloakAuthUrl = url)
            }
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ callback
fun handleKeycloakCallback(callbackUrl: String) {
    viewModelScope.launch {
        handleKeycloakCallbackUseCase(callbackUrl)
            .onSuccess { (token, user) ->
                _uiState.value = _uiState.value.copy(
                    isAuthenticated = true,
                    user = user
                )
            }
    }
}
```

### 4. AuthScreen

```kotlin
@Composable
fun AuthScreen(onLoginSuccess: () -> Unit) {
    val viewModel: AuthViewModel = koinViewModel()
    val uiState by viewModel.uiState.collectAsState()

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ URL
    LaunchedEffect(uiState.keycloakAuthUrl) {
        uiState.keycloakAuthUrl?.let { url ->
            openUrlInBrowser(url)
            viewModel.clearKeycloakAuthUrl()
        }
    }

    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ callback
    SetupOAuthCallbackHandler { callbackUrl ->
        viewModel.handleKeycloakCallback(callbackUrl)
    }
    
    // UI —Å –∫–Ω–æ–ø–∫–æ–π "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä"
    Button(onClick = { viewModel.startKeycloakOAuth() }) {
        Text("–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä (OAuth)")
    }
}
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Android

#### 1. AndroidManifest.xml

–î–æ–±–∞–≤–ª–µ–Ω Intent Filter –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ Deep Links:

```xml
<activity
    android:name=".MainActivity"
    android:launchMode="singleTask">
    
    <!-- Deep Link –¥–ª—è OAuth callback -->
    <intent-filter>
        <action android:name="android.intent.action.VIEW" />
        <category android:name="android.intent.category.DEFAULT" />
        <category android:name="android.intent.category.BROWSABLE" />
        
        <data
            android:scheme="tutuemployee"
            android:host="oauth"
            android:pathPrefix="/callback" />
    </intent-filter>
</activity>
```

#### 2. MainActivity

–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö Deep Links:

```kotlin
class MainActivity : ComponentActivity() {
    private var oauthCallback: ((String) -> Unit)? = null
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        handleIntent(intent)
    }
    
    override fun onNewIntent(intent: Intent) {
        super.onNewIntent(intent)
        handleIntent(intent)
    }
    
    private fun handleIntent(intent: Intent?) {
        val data = intent?.data
        if (data != null && data.toString().startsWith("tutuemployee://oauth/callback")) {
            oauthCallback?.invoke(data.toString())
        }
    }
}
```

#### 3. build.gradle.kts

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è Chrome Custom Tabs:

```kotlin
androidMain.dependencies {
    implementation(libs.androidx.browser)
}
```

### Keycloak

#### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Client

–í Keycloak Admin Console –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ `dom-confluence`:

**Valid Redirect URIs:**

```
tutuemployee://oauth/callback
```

**Client Authentication:** OFF (Public client)

**Standard Flow Enabled:** ON

**Direct Access Grants:** ON (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è fallback)

#### 2. KeycloakConfig.kt

```kotlin
data class KeycloakConfig(
    val serverUrl: String = "https://keycloak.tutu.ru",
    val realm: String = "tutu",
    val clientId: String = "dom-confluence",
    val redirectUri: String = "tutuemployee://oauth/callback"
)
```

## Workflow –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä"

```kotlin
Button(onClick = { viewModel.startKeycloakOAuth() }) {
    Icon(Icons.Default.Language)
    Text("–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä (OAuth)")
}
```

### 2. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç URL —Å PKCE

```
https://keycloak.tutu.ru/realms/tutu/protocol/openid-connect/auth?
  client_id=dom-confluence&
  redirect_uri=tutuemployee://oauth/callback&
  response_type=code&
  scope=openid%20profile%20email&
  state=abc123...&
  code_challenge=xyz789...&
  code_challenge_method=S256
```

### 3. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä —Å Keycloak

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞ Keycloak
- –ï—Å–ª–∏ —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ (SSO)
- –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –≤–≤–æ–¥–∏—Ç –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å

### 4. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

Keycloak –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞:

```
tutuemployee://oauth/callback?code=AUTH_CODE&state=abc123...
```

### 5. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç Deep Link

- Android: —á–µ—Ä–µ–∑ Intent Filter
- iOS: —á–µ—Ä–µ–∑ URL Scheme
- Web: —á–µ—Ä–µ–∑ window.location –∏–ª–∏ postMessage

### 6. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç code –Ω–∞ —Ç–æ–∫–µ–Ω—ã

```http
POST /realms/tutu/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&
code=AUTH_CODE&
redirect_uri=tutuemployee://oauth/callback&
client_id=dom-confluence&
code_verifier=PKCE_VERIFIER
```

### 7. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

```json
{
  "access_token": "eyJhbG...",
  "refresh_token": "eyJhbG...",
  "id_token": "eyJhbG...",
  "token_type": "Bearer",
  "expires_in": 300
}
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### PKCE (Proof Key for Code Exchange)

1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Code Verifier** - —Å–ª—É—á–∞–π–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ 43-128 —Å–∏–º–≤–æ–ª–æ–≤
2. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Code Challenge** - SHA256(code_verifier), base64url encoded
3. **Authorization Request** - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è code_challenge
4. **Token Request** - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è code_verifier
5. **Keycloak –ø—Ä–æ–≤–µ—Ä—è–µ—Ç** - SHA256(code_verifier) == code_challenge

### State Parameter

- –°–ª—É—á–∞–π–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç CSRF
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥ authorization request
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ callback

### Custom URL Scheme

- **Android**: `tutuemployee://oauth/callback`
- **iOS**: `tutuemployee://oauth/callback`
- –¢–æ–ª—å–∫–æ –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å —ç—Ç–æ—Ç URL

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```bash
./gradlew :composeApp:installDebug
```

### 2. –ù–∞–∂–∞—Ç–∏–µ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä"

- –î–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å—Å—è –±—Ä–∞—É–∑–µ—Ä —Å Keycloak
- URL –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: client_id, redirect_uri, code_challenge

### 3. –í—Ö–æ–¥ –≤ Keycloak

- –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å
- –ò–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å SSO, –µ—Å–ª–∏ —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ redirect

```bash
# Android: –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
adb logcat | grep "tutuemployee://oauth"
```

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

- Access token —Å–æ—Ö—Ä–∞–Ω–µ–Ω
- User info –ø–æ–ª—É—á–µ–Ω
- UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–±–ª–µ–º–∞: –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è

**Android:**

```kotlin
// –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
AndroidContextProvider.applicationContext
```

**iOS:**

```kotlin
// –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ URL scheme –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ Info.plist
```

### –ü—Ä–æ–±–ª–µ–º–∞: Deep Link –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**Android:**

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ Intent Filter
adb shell dumpsys package r | grep tutuemployee

# –¢–µ—Å—Ç Deep Link
adb shell am start -W -a android.intent.action.VIEW \
  -d "tutuemployee://oauth/callback?code=test"
```

### –ü—Ä–æ–±–ª–µ–º–∞: Invalid redirect_uri –≤ Keycloak

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Keycloak Admin:

1. Client Settings ‚Üí Valid Redirect URIs
2. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å: `tutuemployee://oauth/callback`
3. –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (case-sensitive!)

### –ü—Ä–æ–±–ª–µ–º–∞: PKCE validation failed

```kotlin
// –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ code_verifier —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
private var currentCodeVerifier: String? = null
```

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### 1. OAuth —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) ‚úÖ

```kotlin
viewModel.startKeycloakOAuth()
```

**–ü–ª—é—Å—ã:** –ë–µ–∑–æ–ø–∞—Å–Ω–æ, SSO, MFA support
**–ú–∏–Ω—É—Å—ã:** –¢—Ä–µ–±—É–µ—Ç Deep Link –Ω–∞—Å—Ç—Ä–æ–π–∫—É

### 2. Direct Password Flow (Fallback)

```kotlin
viewModel.loginWithKeycloak(username, password)
```

**–ü–ª—é—Å—ã:** –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
**–ú–∏–Ω—É—Å—ã:** –ü–∞—Ä–æ–ª—å –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –Ω–µ—Ç SSO

### 3. Legacy API

```kotlin
viewModel.login(username, password)
```

**–ü–ª—é—Å—ã:** –†–∞–±–æ—Ç–∞–µ—Ç —Å–æ —Å—Ç–∞—Ä—ã–º API
**–ú–∏–Ω—É—Å—ã:** –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Keycloak

## Roadmap

### Android

- ‚úÖ Chrome Custom Tabs
- ‚úÖ Deep Link handling
- ‚úÖ PKCE support
- ‚úÖ State validation

### iOS

- ‚úÖ Safari / ASWebAuthenticationSession
- ‚ö†Ô∏è Deep Link handling (—Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Info.plist)
- ‚úÖ PKCE support

### Web (JS/WASM)

- ‚úÖ window.open
- ‚ö†Ô∏è postMessage callback (TODO)
- ‚úÖ PKCE support

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [OAuth 2.0 –¥–ª—è Native Apps (RFC 8252)](https://tools.ietf.org/html/rfc8252)
- [PKCE (RFC 7636)](https://tools.ietf.org/html/rfc7636)
- [OAuth 2.0 Security Best Practices](https://tools.ietf.org/html/draft-ietf-oauth-security-topics)
- [Keycloak Documentation](https://www.keycloak.org/docs/latest/securing_apps/)

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä - —ç—Ç–æ **–±–µ–∑–æ–ø–∞—Å–Ω—ã–π, —É–¥–æ–±–Ω—ã–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π** —Å–ø–æ—Å–æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è
–º–æ–±–∏–ª—å–Ω—ã—Ö –∏ –¥–µ—Å–∫—Ç–æ–ø–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–µ–¥—É–µ—Ç –∏–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∏ best practices.

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é!** üéâ
